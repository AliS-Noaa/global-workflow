#! /usr/bin/env bash

source "${HOMEgfs}/ush/preamble.sh"
source "${HOMEgfs}/ush/jjob_header.sh" -e "stage_ic" -c "base stage_ic"

# Since ICs will download to DATA if DO_DOWNLOAD_ICS is YES, set ICSDIR to DATA
if [[ "${DO_DOWNLOAD_ICS}" == "YES" ]]; then
  export ICSDIR=${DATA}
fi

if [[ "${DO_REPAIR_REPLAY}" == "YES" ]]; then
  # Since replay analysis will download to DATA if DO_DOWNLOAD_ANLY is YES, set ICSDIR to DATA
  if [[ "${DO_DOWNLOAD_ANLY}" == "YES" ]]; then
    export ANLYDIR=${DATA}
  fi
fi

# Execute staging
"${SCRgfs}/exglobal_stage_ic.py"
err=$?

###############################################################
# Check for errors and exit if any of the above failed
if [[ "${err}" -ne 0 ]]; then
  echo "FATAL ERROR: Unable to copy ICs to ${ROTDIR}; ABORT!"
  exit "${err}"
fi

##########################################
# Remove the Temporary working directory
##########################################
cd "${DATAROOT}" || (echo "${DATAROOT} does not exist. ABORT!"; exit 1)
[[ ${KEEPDATA} = "NO" ]] && rm -rf "${DATA}"

exit 0
